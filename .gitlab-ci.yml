image: $CI_REGISTRY/anthony/sherpa/sherpa-build:latest

variables:
  GIT_DEPTH: 10

stages:
  - build
  - test
  - build-site
  - deploy

build_core:
  stage: build
  image: $CI_REGISTRY/anthony/sherpa/sherpa-build:latest
  rules:
    - when: always
  script:
    - ./scripts/bootstrap_binary
  artifacts:
    untracked: false
    when: on_success
    expire_in: "7 days"
    paths:
      - "source/lib/sherpa-core/lib/"
      - "source/lib/sherpa-core/grammar/compile/parser/sherpa.rs"

build_wasm:
  stage: build
  image: $CI_REGISTRY/anthony/sherpa/sherpa-build:latest
  rules:
    - when: always
  script:
    - "curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh"
    - ./scripts/build_wasm
  artifacts:
    untracked: false
    when: on_success
    expire_in: "7 days"
    paths:
      - "source/web/sherpa-wasm/pkg"

build_site_node:
  stage: build-site
  image: node:19-slim
  needs: []
  rules:
    - when: always
  script:
    - cd ./source/web/doc
    - npm install
  artifacts:
    untracked: false
    when: on_success
    expire_in: "15 min"
    paths:
      - "source/web/doc/node_modules"

build_site_hugo:
  stage: build-site
  image: klakegg/hugo:0.107.0-ext-alpine-ci
  needs:
    - build_site_node
    - build_wasm
  rules:
    - when: on_success
  script:
    - mkdir -p ./source/web/doc/assets/js/sherpa
    - mkdir -p ./source/web/doc/static/js/lab
    - cp ./source/web/sherpa-wasm/pkg/* ./source/web/doc/assets/js/sherpa
    - mv ./source/web/doc/assets/js/sherpa/sherpa_wasm_bg.wasm ./source/web/doc/static/js/lab
    - cd ./source/web/doc
    - hugo
  artifacts:
    untracked: false
    when: on_success
    expire_in: "7 days"
    paths:
      - "source/web/doc/public"

pages:
  stage: deploy
  image: alpine
  environment: production
  needs:
    - build_site_hugo
  rules:
    - when: on_success
  script:
    - mkdir public
    - cp -rf source/web/doc/public/* ./public
  artifacts:
    paths:
      - public

test_sherpa:
  stage: test
  image: $CI_REGISTRY/anthony/sherpa/sherpa-build:latest
  needs:
    - "build_core"
  rules:
    - when: on_success
  script:
    - ./scripts/run_tests
